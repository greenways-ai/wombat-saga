name: Publish Book to GitHub Pages

on:
  push:
    tags:
      - 'book-*-v*'
    branches: [main, master]
    paths:
      - 'books/**'
      - '.github/workflows/publish-book-to-pages.yml'
      - '.github/workflows/templates/**'
  workflow_dispatch:
    inputs:
      book_id:
        description: 'Book ID (e.g., sample-book)'
        required: true
        default: 'sample-book'
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    name: Build Book Site
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc yq

      - name: Build book site
        run: |
          # Determine which book to build
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref_type }}" = "tag" ]; then
            TAG="${{ github.ref_name }}"
            if [[ "$TAG" =~ ^book-(.+)-v(.+)$ ]]; then
              BOOK_ID="${BASH_REMATCH[1]}"
            else
              BOOK_ID="sample-book"
            fi
          else
            BOOK_ID="${{ github.event.inputs.book_id || 'sample-book' }}"
          fi
          
          echo "Building book: $BOOK_ID"
          
          CONFIG_FILE="books/$BOOK_ID/config.yml"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "Config file not found: $CONFIG_FILE"
            exit 1
          fi
          
          mkdir -p _site/books/$BOOK_ID
          
          BOOK_TITLE=$(yq e '.book.title.en' "$CONFIG_FILE")
          BOOK_AUTHOR=$(yq e '.book.author' "$CONFIG_FILE")
          LANGUAGES=$(yq e '.languages | keys | .[]' "$CONFIG_FILE")
          
          # Process each language
          for LANG in $LANGUAGES; do
            echo "Processing language: $LANG"
            
            LANG_DIR="books/$BOOK_ID/$LANG"
            if [ ! -d "$LANG_DIR" ]; then
              echo "Warning: Language directory not found: $LANG_DIR"
              continue
            fi
            
            LANG_TITLE=$(yq e ".book.title.$LANG" "$CONFIG_FILE")
            [ "$LANG_TITLE" = "null" ] && LANG_TITLE="$BOOK_TITLE"
            
            mkdir -p "_site/books/$BOOK_ID/$LANG"
            
            # Get chapter files
            CHAPTER_FILES=$(find "$LANG_DIR" -name "*.md" -type f | sort)
            
            # Build chapters.json
            {
              echo "{"
              echo '  "bookId": "'$BOOK_ID'",'
              echo '  "lang": "'$LANG'",'
              echo '  "title": "'$LANG_TITLE'",'
              echo '  "author": "'$BOOK_AUTHOR'",'
              echo '  "chapters": ['
              
              FIRST=true
              for FILE in $CHAPTER_FILES; do
                BASENAME=$(basename "$FILE" .md)
                CHAPTER_TITLE=$(grep -m1 "^title:" "$FILE" 2>/dev/null | sed 's/title: *//' | sed 's/["'"'"]//g' | xargs || echo "$BASENAME")
                
                if [ "$FIRST" = true ]; then
                  FIRST=false
                else
                  echo ","
                fi
                echo -n '    {"file": "'$BASENAME'.html", "title": "'$CHAPTER_TITLE'"}'
                
                # Convert to HTML
                pandoc \
                  --from markdown+yaml_metadata_block \
                  --to html5 \
                  --output "_site/books/$BOOK_ID/$LANG/${BASENAME}.html" \
                  --metadata title="$CHAPTER_TITLE" \
                  --metadata lang="$LANG" \
                  --wrap=none \
                  --no-highlight \
                  "$FILE"
              done
              
              echo ""
              echo "  ]"
              echo "}"
            } > "_site/books/$BOOK_ID/$LANG/chapters.json"
          done
          
          # Copy shared assets
          mkdir -p "_site/books/$BOOK_ID/assets"
          cp .github/workflows/templates/book.css "_site/books/$BOOK_ID/assets/"
          cp .github/workflows/templates/book.js "_site/books/$BOOK_ID/assets/"

      - name: Create book pages
        run: |
          BOOK_ID="${{ github.event.inputs.book_id || 'sample-book' }}"
          CONFIG_FILE="books/$BOOK_ID/config.yml"
          
          BOOK_TITLE=$(yq e '.book.title.en' "$CONFIG_FILE")
          BOOK_AUTHOR=$(yq e '.book.author' "$CONFIG_FILE")
          LANGUAGES=$(yq e '.languages | keys | .[]' "$CONFIG_FILE")
          
          # Create languages.json
          {
            echo "["
            FIRST_LANG=true
            for LANG in $LANGUAGES; do
              LANG_NAME=$(yq e ".languages.\"$LANG\".name" "$CONFIG_FILE")
              if [ "$FIRST_LANG" = true ]; then
                FIRST_LANG=false
              else
                echo ","
              fi
              echo -n '{"code": "'$LANG'", "name": "'$LANG_NAME'"}'
            done
            echo ""
            echo "]"
          } > "_site/books/$BOOK_ID/languages.json"
          
          # Create language index pages
          for LANG in $LANGUAGES; do
            LANG_TITLE=$(yq e ".book.title.$LANG" "$CONFIG_FILE")
            [ "$LANG_TITLE" = "null" ] && LANG_TITLE="$BOOK_TITLE"
            
            cat > "_site/books/$BOOK_ID/$LANG/index.html" << EOF
<!DOCTYPE html>
<html lang="$LANG">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>$LANG_TITLE</title>
  <link rel="stylesheet" href="../assets/book.css">
</head>
<body>
  <div class="book-container">
    <nav class="book-sidebar">
      <div class="sidebar-header">
        <h1 class="book-title">$LANG_TITLE</h1>
        <p class="book-author">$BOOK_AUTHOR</p>
        <div class="language-selector">
          <select id="lang-select" aria-label="Select language"></select>
        </div>
      </div>
      <div class="toc" id="toc"></div>
    </nav>
    <main class="book-content">
      <div id="chapter-content"><div class="loading">Loading...</div></div>
      <nav class="chapter-nav">
        <button id="prev-btn" class="nav-btn" disabled>Previous</button>
        <a href="../" class="nav-btn">All Books</a>
        <button id="next-btn" class="nav-btn" disabled>Next</button>
      </nav>
    </main>
  </div>
  <script src="../assets/book.js"></script>
</body>
</html>
EOF
          done
          
          # Create book landing page
          cat > "_site/books/$BOOK_ID/index.html" << EOF
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>$BOOK_TITLE</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .book-card {
      background: white;
      border-radius: 16px;
      padding: 3rem;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: #333; }
    .author { color: #666; margin-bottom: 2rem; font-size: 1.1rem; }
    .languages { margin-top: 2rem; }
    .languages h2 {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #999;
      margin-bottom: 1rem;
    }
    .lang-list { display: flex; flex-wrap: wrap; gap: 0.75rem; }
    .lang-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: #f5f5f5;
      border-radius: 8px;
      text-decoration: none;
      color: #333;
      font-weight: 500;
      transition: all 0.2s;
    }
    .lang-btn:hover { background: #667eea; color: white; transform: translateY(-2px); }
    .lang-code { font-size: 0.75rem; opacity: 0.6; text-transform: uppercase; }
    .back-link { display: inline-block; margin-top: 2rem; color: #667eea; text-decoration: none; }
    .back-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="book-card">
    <h1>$BOOK_TITLE</h1>
    <p class="author">by $BOOK_AUTHOR</p>
    <div class="languages">
      <h2>Choose your language</h2>
      <div class="lang-list">
EOF

          for LANG in $LANGUAGES; do
            LANG_NAME=$(yq e ".languages.\"$LANG\".name" "$CONFIG_FILE")
            echo "        <a href=\"$LANG/\" class=\"lang-btn\"><span>$LANG_NAME</span><span class=\"lang-code\">$LANG</span></a>" >> "_site/books/$BOOK_ID/index.html"
          done
          
          cat >> "_site/books/$BOOK_ID/index.html" << EOF
      </div>
    </div>
    <a href="../" class="back-link">All Books</a>
  </div>
</body>
</html>
EOF

      - name: Create main books index
        run: |
          mkdir -p _site/books
          cat > _site/books/index.html << 'INDEXEOF'
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Books | Wombat Worlds Saga</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      padding: 3rem 1rem;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: #333; }
    .subtitle { color: #666; margin-bottom: 3rem; }
    .books-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 2rem;
    }
    .book-card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .book-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    .book-card a { text-decoration: none; color: inherit; }
    .book-title { font-size: 1.5rem; margin-bottom: 0.5rem; color: #333; }
    .book-author { color: #666; font-size: 0.95rem; }
    .book-langs { margin-top: 1rem; font-size: 0.85rem; color: #999; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Books</h1>
    <p class="subtitle">Multi-language publications from the Wombat Worlds Saga</p>
    <div class="books-grid">
      <div class="book-card">
        <a href="sample-book/">
          <h2 class="book-title">The Wombat Chronicles</h2>
          <p class="book-author">by The Oracle</p>
          <p class="book-langs">Available in: English, Español, Français, Deutsch</p>
        </a>
      </div>
    </div>
  </div>
</body>
</html>
INDEXEOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4
