name: Publish Book to GitHub Pages

on:
  push:
    tags:
      - 'book-*-v*'
    branches: [main, master]
    paths:
      - 'books/**'
      - '.github/workflows/publish-book-to-pages.yml'
  workflow_dispatch:
    inputs:
      book_id:
        description: 'Book ID (e.g., sample-book)'
        required: true
        default: 'sample-book'
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  # ========== Build Book Site ==========
  build:
    name: Build Book Site
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc yq

      - name: Build book site
        run: |
          # Determine which book to build
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref_type }}" = "tag" ]; then
            # Parse from tag: book-{id}-v{version}
            TAG="${{ github.ref_name }}"
            if [[ "$TAG" =~ ^book-(.+)-v(.+)$ ]]; then
              BOOK_ID="${BASH_REMATCH[1]}"
            else
              echo "Invalid tag format. Using default."
              BOOK_ID="sample-book"
            fi
          else
            BOOK_ID="${{ github.event.inputs.book_id || 'sample-book' }}"
          fi
          
          echo "Building book: $BOOK_ID"
          
          CONFIG_FILE="books/$BOOK_ID/config.yml"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "Config file not found: $CONFIG_FILE"
            exit 1
          fi
          
          # Create site directory structure
          mkdir -p _site/books/$BOOK_ID
          
          # Get book metadata
          BOOK_TITLE=$(yq e '.book.title.en' "$CONFIG_FILE")
          BOOK_AUTHOR=$(yq e '.book.author' "$CONFIG_FILE")
          DEFAULT_LANG=$(yq e '.book.default_language' "$CONFIG_FILE")
          
          # Get all languages
          LANGUAGES=$(yq e '.languages | keys | .[]' "$CONFIG_FILE")
          
          # Function to convert markdown to HTML
          convert_to_html() {
            local input_file="$1"
            local output_file="$2"
            local title="$3"
            local lang="$4"
            
            pandoc \
              --from markdown+yaml_metadata_block \
              --to html5 \
              --output "$output_file" \
              --metadata title="$title" \
              --metadata lang="$lang" \
              --wrap=none \
              --no-highlight \
              "$input_file"
          }
          
          # Process each language
          for LANG in $LANGUAGES; do
            echo "Processing language: $LANG"
            
            LANG_DIR="books/$BOOK_ID/$LANG"
            if [ ! -d "$LANG_DIR" ]; then
              echo "Warning: Language directory not found: $LANG_DIR"
              continue
            fi
            
            # Get language-specific title
            LANG_TITLE=$(yq e ".book.title.$LANG" "$CONFIG_FILE")
            [ "$LANG_TITLE" = "null" ] && LANG_TITLE="$BOOK_TITLE"
            
            # Create language output directory
            mkdir -p "_site/books/$BOOK_ID/$LANG"
            
            # Get chapter order from config
            CHAPTER_FILES=$(yq e '.structure[] | .chapters[] | select(.type != "cover") | .file' "$CONFIG_FILE")
            
            # Track chapters for TOC
            CHAPTERS_JSON="["
            FIRST_CHAPTER=""
            PREV_CHAPTER=""
            
            for FILE in $CHAPTER_FILES; do
              SRC="$LANG_DIR/$FILE"
              if [ ! -f "$SRC" ]; then
                continue
              fi
              
              # Generate HTML filename
              BASENAME=$(basename "$FILE" .md)
              HTML_FILE="${BASENAME}.html"
              OUTPUT="_site/books/$BOOK_ID/$LANG/$HTML_FILE"
              
              # Get chapter title from frontmatter or use filename
              CHAPTER_TITLE=$(grep -m1 "^title:" "$SRC" | sed 's/title: *//' | sed 's/["'"'"]//g' | xargs)
              [ -z "$CHAPTER_TITLE" ] && CHAPTER_TITLE="$BASENAME"
              
              # Convert to HTML (content only, no template)
              pandoc \
                --from markdown+yaml_metadata_block \
                --to html5 \
                --output "$OUTPUT" \
                --metadata title="$CHAPTER_TITLE" \
                --metadata lang="$lang" \
                --wrap=none \
                --no-highlight \
                --template=<(echo '$body$') \
                "$SRC" 2>/dev/null || \
              pandoc \
                --from markdown+yaml_metadata_block \
                --to html5 \
                --output "$OUTPUT" \
                --metadata title="$CHAPTER_TITLE" \
                --metadata lang="$lang" \
                --wrap=none \
                --no-highlight \
                "$SRC"
              
              # Track chapters for navigation
              if [ -z "$FIRST_CHAPTER" ]; then
                FIRST_CHAPTER="$HTML_FILE"
              fi
              
              # Add to chapters JSON
              if [ "$CHAPTERS_JSON" != "[" ]; then
                CHAPTERS_JSON="$CHAPTERS_JSON,"
              fi
              CHAPTERS_JSON="$CHAPTERS_JSON{\"file\":\"$HTML_FILE\",\"title\":\"$CHAPTER_TITLE\"}"
              
              PREV_CHAPTER="$HTML_FILE"
            done
            
            CHAPTERS_JSON="$CHAPTERS_JSON]"
            
            # Create language index with reader template
            cat > "_site/books/$BOOK_ID/$LANG/index.html" << EOF
<!DOCTYPE html>
<html lang="$LANG">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>$LANG_TITLE</title>
  <link rel="stylesheet" href="../assets/book.css">
</head>
<body data-book="$BOOK_ID" data-lang="$LANG">
  <div class="book-container">
    <nav class="book-sidebar">
      <div class="sidebar-header">
        <h1 class="book-title">$LANG_TITLE</h1>
        <p class="book-author">$BOOK_AUTHOR</p>
        <div class="language-selector">
          <select id="lang-select" aria-label="Select language">
            <!-- Options populated by JS -->
          </select>
        </div>
      </div>
      <div class="toc" id="toc">
        <!-- TOC populated by JS -->
      </div>
    </nav>
    
    <main class="book-content">
      <div id="chapter-content">
        <div class="loading">Loading...</div>
      </div>
      
      <nav class="chapter-nav">
        <button id="prev-btn" class="nav-btn" disabled>‚Üê Previous</button>
        <a href="../" class="nav-btn">All Books</a>
        <button id="next-btn" class="nav-btn" disabled>Next ‚Üí</button>
      </nav>
    </main>
  </div>
  
  <script>
    window.BOOK_CONFIG = {
      bookId: '$BOOK_ID',
      lang: '$LANG',
      chapters: $CHAPTERS_JSON,
      defaultChapter: '$FIRST_CHAPTER'
    };
  </script>
  <script src="../assets/book.js"></script>
</body>
</html>
EOF
            
          done
          
          # Create shared assets
          mkdir -p "_site/books/$BOOK_ID/assets"
          
          # Create book.css
          cat > "_site/books/$BOOK_ID/assets/book.css" << 'EOF'
/* Book Reader Styles */

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --sidebar-width: 280px;
  --content-max-width: 720px;
  --bg-color: #faf8f5;
  --text-color: #333;
  --sidebar-bg: #2c3e50;
  --sidebar-text: #ecf0f1;
  --accent: #e74c3c;
  --border: #ddd;
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg-color: #1a1a1a;
    --text-color: #e0e0e0;
    --sidebar-bg: #1e2a3a;
    --sidebar-text: #bdc3c7;
    --border: #444;
  }
}

body {
  font-family: Georgia, "Times New Roman", serif;
  font-size: 18px;
  line-height: 1.8;
  color: var(--text-color);
  background: var(--bg-color);
}

.book-container {
  display: flex;
  min-height: 100vh;
}

/* Sidebar */
.book-sidebar {
  width: var(--sidebar-width);
  background: var(--sidebar-bg);
  color: var(--sidebar-text);
  position: fixed;
  height: 100vh;
  overflow-y: auto;
  padding: 1.5rem;
}

.sidebar-header {
  border-bottom: 1px solid rgba(255,255,255,0.1);
  padding-bottom: 1rem;
  margin-bottom: 1rem;
}

.book-title {
  font-size: 1.3rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  line-height: 1.3;
}

.book-author {
  font-size: 0.9rem;
  opacity: 0.8;
  margin-bottom: 1rem;
}

.language-selector select {
  width: 100%;
  padding: 0.5rem;
  border: none;
  border-radius: 4px;
  background: rgba(255,255,255,0.1);
  color: var(--sidebar-text);
  font-size: 0.9rem;
  cursor: pointer;
}

.language-selector select option {
  background: var(--sidebar-bg);
  color: var(--sidebar-text);
}

/* TOC */
.toc {
  font-size: 0.95rem;
}

.toc ul {
  list-style: none;
}

.toc li {
  margin: 0.3rem 0;
}

.toc a {
  color: var(--sidebar-text);
  text-decoration: none;
  display: block;
  padding: 0.4rem 0.6rem;
  border-radius: 4px;
  opacity: 0.85;
  transition: all 0.2s;
}

.toc a:hover,
.toc a.active {
  background: rgba(255,255,255,0.1);
  opacity: 1;
}

.toc .part-header {
  font-weight: 600;
  margin-top: 1rem;
  padding: 0.4rem 0.6rem;
  opacity: 0.6;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* Main Content */
.book-content {
  margin-left: var(--sidebar-width);
  flex: 1;
  padding: 3rem 2rem;
  max-width: calc(var(--content-max-width) + var(--sidebar-width));
}

#chapter-content {
  max-width: var(--content-max-width);
  margin: 0 auto;
}

/* Typography */
#chapter-content h1 {
  font-size: 2.2rem;
  margin-bottom: 1.5rem;
  line-height: 1.2;
}

#chapter-content h2 {
  font-size: 1.6rem;
  margin-top: 2rem;
  margin-bottom: 1rem;
}

#chapter-content h3 {
  font-size: 1.3rem;
  margin-top: 1.5rem;
  margin-bottom: 0.8rem;
}

#chapter-content p {
  margin-bottom: 1.2rem;
  text-align: justify;
  hyphens: auto;
}

#chapter-content blockquote {
  margin: 1.5rem 0;
  padding: 0.5rem 1.5rem;
  border-left: 3px solid var(--accent);
  font-style: italic;
  opacity: 0.9;
}

#chapter-content hr {
  border: none;
  text-align: center;
  margin: 2rem 0;
}

#chapter-content hr::after {
  content: "* * *";
  letter-spacing: 1em;
  opacity: 0.5;
}

/* Chapter Navigation */
.chapter-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 3rem;
  padding-top: 2rem;
  border-top: 1px solid var(--border);
  max-width: var(--content-max-width);
  margin-left: auto;
  margin-right: auto;
}

.nav-btn {
  padding: 0.6rem 1.2rem;
  background: var(--sidebar-bg);
  color: var(--sidebar-text);
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.95rem;
  text-decoration: none;
  transition: opacity 0.2s;
}

.nav-btn:hover:not(:disabled) {
  opacity: 0.9;
}

.nav-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* Loading */
.loading {
  text-align: center;
  padding: 3rem;
  opacity: 0.6;
}

/* Mobile */
@media (max-width: 768px) {
  .book-sidebar {
    transform: translateX(-100%);
    transition: transform 0.3s;
    z-index: 100;
  }
  
  .book-sidebar.open {
    transform: translateX(0);
  }
  
  .book-content {
    margin-left: 0;
    padding: 1.5rem;
  }
  
  .menu-toggle {
    display: block;
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 101;
    background: var(--sidebar-bg);
    color: var(--sidebar-text);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
  }
}

/* Print */
@media print {
  .book-sidebar,
  .chapter-nav {
    display: none;
  }
  
  .book-content {
    margin-left: 0;
  }
}
EOF
          
          # Create book.js
          cat > "_site/books/$BOOK_ID/assets/book.js" << 'EOF'
// Book Reader JavaScript

(function() {
  const config = window.BOOK_CONFIG;
  if (!config) return;
  
  let currentChapter = 0;
  
  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    loadTOC();
    loadLanguageSelector();
    
    // Load initial chapter from URL hash or default
    const hash = window.location.hash.slice(1);
    const initialChapter = hash || config.defaultChapter;
    loadChapter(initialChapter);
    
    // Setup navigation buttons
    document.getElementById('prev-btn').addEventListener('click', goToPrev);
    document.getElementById('next-btn').addEventListener('click', goToNext);
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowLeft') goToPrev();
      if (e.key === 'ArrowRight') goToNext();
    });
    
    // Handle language change
    document.getElementById('lang-select').addEventListener('change', function(e) {
      const newLang = e.target.value;
      const currentFile = config.chapters[currentChapter]?.file;
      window.location.href = `../${newLang}/#${currentFile}`;
    });
  });
  
  function loadTOC() {
    const toc = document.getElementById('toc');
    const ul = document.createElement('ul');
    
    config.chapters.forEach((chapter, index) => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = `#${chapter.file}`;
      a.textContent = chapter.title;
      a.dataset.index = index;
      a.addEventListener('click', function(e) {
        e.preventDefault();
        loadChapter(chapter.file);
      });
      li.appendChild(a);
      ul.appendChild(li);
    });
    
    toc.appendChild(ul);
  }
  
  function loadLanguageSelector() {
    // Get available languages from the book structure
    const select = document.getElementById('lang-select');
    const currentLang = config.lang;
    
    // Fetch available languages
    fetch('../languages.json')
      .then(r => r.json())
      .then(langs => {
        select.innerHTML = langs.map(lang => 
          `<option value="${lang.code}" ${lang.code === currentLang ? 'selected' : ''}>
            ${lang.name}
          </option>`
        ).join('');
      })
      .catch(() => {
        // Fallback - just show current language
        select.innerHTML = `<option value="${currentLang}">${currentLang}</option>`;
      });
  }
  
  function loadChapter(filename) {
    if (!filename) return;
    
    const contentDiv = document.getElementById('chapter-content');
    contentDiv.innerHTML = '<div class="loading">Loading...</div>';
    
    // Find chapter index
    const chapterIndex = config.chapters.findIndex(c => c.file === filename);
    if (chapterIndex === -1) {
      contentDiv.innerHTML = '<p>Chapter not found.</p>';
      return;
    }
    
    currentChapter = chapterIndex;
    
    // Load chapter content
    fetch(filename)
      .then(response => {
        if (!response.ok) throw new Error('Failed to load');
        return response.text();
      })
      .then(html => {
        // Extract body content
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const body = doc.body;
        
        // Clean up and insert
        contentDiv.innerHTML = '';
        
        // Copy all child nodes
        while (body.firstChild) {
          contentDiv.appendChild(body.firstChild);
        }
        
        // Update URL
        window.history.replaceState(null, null, `#${filename}`);
        
        // Update UI
        updateNavigation();
        updateTOCActive();
        
        // Scroll to top
        window.scrollTo(0, 0);
        
        // Update page title
        const chapter = config.chapters[chapterIndex];
        document.title = `${chapter.title} | ${document.querySelector('.book-title').textContent}`;
      })
      .catch(err => {
        contentDiv.innerHTML = `<p>Error loading chapter: ${err.message}</p>`;
      });
  }
  
  function updateNavigation() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    prevBtn.disabled = currentChapter === 0;
    nextBtn.disabled = currentChapter === config.chapters.length - 1;
  }
  
  function updateTOCActive() {
    document.querySelectorAll('.toc a').forEach((a, index) => {
      a.classList.toggle('active', index === currentChapter);
    });
  }
  
  function goToPrev() {
    if (currentChapter > 0) {
      loadChapter(config.chapters[currentChapter - 1].file);
    }
  }
  
  function goToNext() {
    if (currentChapter < config.chapters.length - 1) {
      loadChapter(config.chapters[currentChapter + 1].file);
    }
  }
})();
EOF
          
          # Create languages.json for language switching
          LANGUAGES_JSON="["
          FIRST_LANG=true
          for LANG in $LANGUAGES; do
            LANG_NAME=$(yq e ".languages.\"$LANG\".name" "$CONFIG_FILE")
            if [ "$FIRST_LANG" = true ]; then
              FIRST_LANG=false
            else
              LANGUAGES_JSON="$LANGUAGES_JSON,"
            fi
            LANGUAGES_JSON="$LANGUAGES_JSON{\"code\":\"$LANG\",\"name\":\"$LANG_NAME\"}"
          done
          LANGUAGES_JSON="$LANGUAGES_JSON]"
          
          echo "$LANGUAGES_JSON" > "_site/books/$BOOK_ID/languages.json"
          
          # Create book index page
          cat > "_site/books/$BOOK_ID/index.html" << EOF
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>$BOOK_TITLE</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .book-card {
      background: white;
      border-radius: 16px;
      padding: 3rem;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: #333; }
    .author { color: #666; margin-bottom: 2rem; font-size: 1.1rem; }
    .languages { margin-top: 2rem; }
    .languages h2 {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #999;
      margin-bottom: 1rem;
    }
    .lang-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .lang-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: #f5f5f5;
      border-radius: 8px;
      text-decoration: none;
      color: #333;
      font-weight: 500;
      transition: all 0.2s;
    }
    .lang-btn:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
    }
    .lang-code {
      font-size: 0.75rem;
      opacity: 0.6;
      text-transform: uppercase;
    }
    .back-link {
      display: inline-block;
      margin-top: 2rem;
      color: #667eea;
      text-decoration: none;
    }
    .back-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="book-card">
    <h1>$BOOK_TITLE</h1>
    <p class="author">by $BOOK_AUTHOR</p>
    
    <div class="languages">
      <h2>Choose your language</h2>
      <div class="lang-list">
EOF
          
          for LANG in $LANGUAGES; do
            LANG_NAME=$(yq e ".languages.\"$LANG\".name" "$CONFIG_FILE")
            echo "        <a href=\"$LANG/\" class=\"lang-btn\">
          <span>$LANG_NAME</span>
          <span class=\"lang-code\">$LANG</span>
        </a>" >> "_site/books/$BOOK_ID/index.html"
          done
          
          cat >> "_site/books/$BOOK_ID/index.html" << EOF
      </div>
    </div>
    
    <a href="../" class="back-link">‚Üê All Books</a>
  </div>
</body>
</html>
EOF
          
          echo "Built book site for: $BOOK_ID"
          ls -la _site/books/$BOOK_ID/

      - name: Create main books index
        run: |
          mkdir -p _site/books
          
          cat > _site/books/index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Books | Wombat Worlds Saga</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      padding: 3rem 1rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      color: #333;
    }
    .subtitle {
      color: #666;
      margin-bottom: 3rem;
    }
    .books-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 2rem;
    }
    .book-card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .book-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    .book-card a {
      text-decoration: none;
      color: inherit;
    }
    .book-title {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: #333;
    }
    .book-author {
      color: #666;
      font-size: 0.95rem;
    }
    .book-langs {
      margin-top: 1rem;
      font-size: 0.85rem;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìö Books</h1>
    <p class="subtitle">Multi-language publications from the Wombat Worlds Saga</p>
    
    <div class="books-grid" id="books-grid">
      <!-- Populated by JavaScript -->
    </div>
  </div>
  
  <script>
    // Discover available books
    async function loadBooks() {
      // For now, just show sample-book as example
      // In production, this could scan for book directories
      const books = [
        {
          id: 'sample-book',
          title: 'The Wombat Chronicles',
          author: 'The Oracle',
          languages: ['English', 'Espa√±ol', 'Fran√ßais', 'Deutsch']
        }
      ];
      
      const grid = document.getElementById('books-grid');
      grid.innerHTML = books.map(book => `
        <div class="book-card">
          <a href="${book.id}/">
            <h2 class="book-title">${book.title}</h2>
            <p class="book-author">by ${book.author}</p>
            <p class="book-langs">Available in: ${book.languages.join(', ')}</p>
          </a>
        </div>
      `).join('');
    }
    
    loadBooks();
  </script>
</body>
</html>
EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  # ========== Deploy to GitHub Pages ==========
  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4
